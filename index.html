<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Feliz San Valent√≠n Bubu</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            text-align: center;
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 100px;
            user-select: none;
            -webkit-user-select: none;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding-top: 30px;
            position: relative;
            z-index: 1;
        }

        /* --- PARTICULAS --- */
        #particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        .particle { position: absolute; text-shadow: 0 0 5px rgba(255, 255, 255, 0.3); font-size: 1.5rem; animation: floatUp linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 15% { opacity: 0.8; } 85% { opacity: 0.8; } 100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; } }

        /* --- TEXTOS --- */
        .gradient-text {
            background: linear-gradient(45deg, #ff7b72, #79c0ff, #d2a8ff, #ff7b72);
            background-size: 300%; -webkit-background-clip: text; background-clip: text; color: transparent;
            font-size: 2.8rem; font-weight: bold; display: inline-block; margin-bottom: 5px; animation: gradient-move 6s ease infinite;
        }
        @keyframes gradient-move { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .heart-beat { color: #ff7b72; animation: latido 1s infinite; display: inline-block; font-size: 2.5rem;}
        @keyframes latido { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- UI COMPONENTS --- */
        .hidden { opacity: 0; transform: translateY(30px); transition: all 0.8s ease-out; }
        .show { opacity: 1; transform: translateY(0); }
        
        .uptime-box { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 15px; margin: 20px auto; max-width: 600px; font-size: 1.2rem; color: #7ee787; box-shadow: 0 0 10px rgba(126, 231, 135, 0.1); }
        .label { font-size: 0.8rem; color: #8b949e; display: block; margin-top: 5px; font-weight: normal;}

        .gallery-centered { display: flex; gap: 20px; align-items: center; margin: 40px 0; }
        .side-column { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .center-column { flex: 2; }
        .photo-frame { border-radius: 12px; overflow: hidden; border: 3px solid #30363d; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3); background: #161b22; }
        .photo-frame img { width: 100%; height: auto; display: block; }
        .center-column .photo-frame { border-color: #ff7b72; transform: scale(1.02); }
        .photo-frame:hover { transform: scale(1.05); border-color: #58a6ff; box-shadow: 0 0 15px rgba(88, 166, 255, 0.6); z-index: 10; }
        @media (max-width: 768px) { .gallery-centered { flex-direction: column; } .side-column, .center-column { width: 100%; flex: auto; } .center-column { order: -1; margin-bottom: 20px;} }

        .changelog { text-align: left; background: #161b22; padding: 25px; border-radius: 10px; border: 1px solid #30363d; margin-top: 50px; max-width: 700px; margin-left: auto; margin-right: auto; }
        .log-item { border-bottom: 1px solid #30363d; padding-bottom: 20px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease; padding: 10px; border-radius: 8px; border: 1px solid transparent; }
        .log-item:hover { background: #21262d; border-color: #58a6ff; box-shadow: 0 0 10px rgba(88, 166, 255, 0.2); transform: translateX(10px); }
        .log-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 10px; }
        .version { color: #79c0ff; font-weight: bold; font-size: 1.1rem;}
        .date { color: #8b949e; font-size: 0.9rem; margin-left: 10px; font-style: italic;}
        .description { margin-top: 8px; color: #c9d1d9; display: block; }
        .click-hint { font-size: 0.7rem; color: #8b949e; float: right; margin-top: 5px; opacity: 0.7;}
        .future-item { border-left: 3px solid #a371f7; padding-left: 15px; opacity: 0.9; }

        .btn { display: inline-block; margin-top: 30px; padding: 12px 24px; background: #238636; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; transition: all 0.3s; }
        .footer { margin-top: 50px; font-size: 0.8rem; color: #484f58; }

        /* --- üéµ REPRODUCTOR --- */
        .music-player-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; align-items: center; gap: 10px; background: rgba(22, 27, 34, 0.9); padding: 10px 15px; border-radius: 50px; border: 1px solid #30363d; box-shadow: 0 0 15px rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .play-btn { background: #238636; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .song-info { display: flex; flex-direction: column; text-align: left; margin-right: 10px; }
        .song-title { font-size: 0.85rem; font-weight: bold; color: #c9d1d9; }
        .song-artist { font-size: 0.7rem; color: #8b949e; }
        .equalizer { display: flex; gap: 3px; height: 15px; align-items: flex-end; }
        .bar { width: 3px; background-color: #58a6ff; animation: bounce 0s infinite; }
        .playing .bar { animation: bounce 1s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { height: 3px; } 50% { height: 15px; } }

        /* --- üíº TARKOV BUTTON --- */
        .loot-container { position: fixed; bottom: 20px; left: 20px; z-index: 100; background: rgba(22, 27, 34, 0.8); border: 1px solid #30363d; border-radius: 5px; padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: transform 0.2s; }
        .loot-container:hover { border-color: #d2a8ff; transform: scale(1.05); }
        .loot-icon { font-size: 1.5rem; }
        .loot-hint { font-size: 0.8rem; color: #c9d1d9; text-transform: uppercase; font-weight: bold; display: none; }
        .loot-container:hover .loot-hint { display: block; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); backdrop-filter: blur(5px); overflow: auto;}
        .modal-content { margin: 5% auto; display: block; max-width: 90%; }
        .close { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 2001; }

        /* --- üéÆ ESTILOS JUEGO TARKOV (GRID HARDCORE 6x8) --- */
        #game-area {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; position: relative;
            padding-bottom: 20px;
        }

        .stash-container {
            background: #151515;
            padding: 8px;
            border: 3px solid #4a4a4a;
            border-radius: 4px;
            margin-bottom: 15px;
            position: relative;
        }
        
        /* GRID DE 6x8 CELDAS (Tama√±o 45px para que quepa en m√≥vil) */
        .stash-grid-bg {
            width: 270px;  /* 6 * 45px */
            height: 360px; /* 8 * 45px */
            background-image: 
                linear-gradient(#333 1px, transparent 1px),
                linear-gradient(90deg, #333 1px, transparent 1px);
            background-size: 45px 45px; 
            background-color: #1a1a1a;
            position: relative;
            border: 1px solid #333;
        }

        /* Area de objetos sueltos */
        .loose-pool {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
            width: 320px; min-height: 80px;
            padding: 10px; border-top: 2px dashed #333;
        }

        /* Los objetos (Items) */
        .item {
            display: flex; align-items: center; justify-content: center;
            background-color: #2a2a2a;
            border: 1px solid #777;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: grab;
            font-size: 1.2rem;
            position: relative; 
            user-select: none;
            touch-action: none; 
            z-index: 10;
            transition: transform 0.1s;
        }
        .item:active { cursor: grabbing; z-index: 9999; transform: scale(1.05); transition: none; }
        .item.placed {
            box-shadow: inset 0 0 10px #4caf50;
            border-color: #4caf50;
            cursor: grab;
        }

        /* TAMA√ëOS (Base 45px por celda) */
        .item[data-w="3"][data-h="3"] { width: 135px; height: 135px; background: #3e3e2e; } /* Mochila/Rig grande */
        .item[data-w="2"][data-h="3"] { width: 90px; height: 135px; background: #4a5a4a; } /* Armor */
        .item[data-w="3"][data-h="2"] { width: 135px; height: 90px; background: #2f353b; } /* Case */
        .item[data-w="6"][data-h="1"] { width: 270px; height: 45px; background: #2b2b2b; } /* Sniper Larga */
        .item[data-w="4"][data-h="2"] { width: 180px; height: 90px; background: #3a2a2a; } /* Caja Grande */
        .item[data-w="2"][data-h="2"] { width: 90px; height: 90px; background: #5a3a5a; } /* Casco */
        .item[data-w="2"][data-h="1"] { width: 90px; height: 45px; background: #5a3a2a; } /* Pistola */
        .item[data-w="1"][data-h="1"] { width: 45px; height: 45px; background: #333; } /* Peque√±os */

        #win-screen { display: none; text-align: center; animation: popIn 0.5s; }
        .found-in-raid-badge {
            background: #111; color: #d2a8ff; border: 1px solid #d2a8ff;
            padding: 5px 15px; display: inline-block; margin-top: 10px; font-weight: bold;
            font-family: 'Consolas', monospace; box-shadow: 0 0 10px rgba(210, 168, 255, 0.2);
        }
        @keyframes popIn { from {transform: scale(0);} to {transform: scale(1);} }

    </style>
</head>
<body>

    <audio id="myAudio" loop>
        <source src="song.mp3" type="audio/mpeg">
    </audio>

    <div class="music-player-container" id="playerWidget">
        <button class="play-btn" onclick="toggleMusic()">‚ñ∂</button>
        <div class="song-info">
            <span class="song-title">Nuestra Canci√≥n</span>
            <span class="song-artist">Amor de cine</span>
        </div>
        <div class="equalizer" id="eq"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
    </div>

    <div class="loot-container" onclick="openGame()">
        <span class="loot-icon">üíº</span>
        <span class="loot-hint">ORGANIZE STASH</span>
    </div>

    <div id="particles-container"></div>

    <div class="container">
        <div>
            <h1 class="gradient-text">FELIZ SAN VALENT√çN BUBU</h1>
        </div>
        <div><span class="heart-beat">‚ù§Ô∏è</span></div>

        <div class="uptime-box hidden">
            <span id="uptime">Calculando...</span>
            <span class="label">Tiempo aguant√°ndonos (y queri√©ndonos)</span>
        </div>

        <div class="gallery-centered hidden">
            <div class="side-column">
                <div class="photo-frame"><img src="1.jpg" alt="Foto 1"></div>
                <div class="photo-frame"><img src="2.jpg" alt="Foto 2"></div>
                <div class="photo-frame"><img src="3.jpg" alt="Foto 3"></div>
            </div>
            <div class="center-column">
                <div class="photo-frame main-photo">
                    <img src="main.jpg" alt="Nosotros Principal">
                </div>
            </div>
            <div class="side-column">
                <div class="photo-frame"><img src="4.jpg" alt="Foto 4"></div>
                <div class="photo-frame"><img src="5.jpg" alt="Foto 5"></div>
                <div class="photo-frame"><img src="6.jpg" alt="Foto 6"></div>
            </div>
        </div>

        <div class="changelog hidden">
            <h3>üìú Historial de nuestra historia</h3>
            <p style="font-size: 0.8rem; color: #8b949e; margin-bottom: 20px;">(Haz clic en cada texto para desbloquear el recuerdo)</p>
            
            <div class="log-item" onclick="openModal('2020.jpg')">
                <span class="version">v2020.06.01 - The Initial Commit</span> 
                <span class="click-hint">üì∑ Ver recuerdo</span>
                <span class="date">01/06/2020</span>
                <span class="description">
                    El d√≠a que decidimos empezar esta partida en modo cooperativo. Se estableci√≥ la conexi√≥n inicial y el ping fue de 0ms (conexi√≥n directa al coraz√≥n).
                </span>
            </div>

            <div class="log-item" onclick="openModal('2021.jpg')">
                <span class="version">v2021 - Compatibility Update</span>
                <span class="click-hint">üì∑ Ver recuerdo</span> 
                <span class="date">2021</span>
                <span class="description">
                    Primer a√±o completo. Se corrigieron los bugs de la verg√ºenza inicial y se mejor√≥ la sincronizaci√≥n.
                </span>
            </div>

            <div class="log-item" onclick="openModal('2022.jpg')">
                <span class="version">v2022 - Expansion Pack</span> 
                <span class="click-hint">üì∑ Ver recuerdo</span>
                <span class="date">2022</span>
                <span class="description">
                    El m√≥dulo de seriedad ha dejado de responder. Ejecutando hacer_el_tonto.exe con la skin de McDonald's.
                </span>
            </div>

            <div class="log-item" onclick="openModal('2023.jpg')">
                <span class="version">v2023 - High Performance</span> 
                <span class="click-hint">üì∑ Ver recuerdo</span>
                <span class="date">2023</span>
                <span class="description">
                    El servidor alcanz√≥ un uptime r√©cord. Superamos desaf√≠os y sumamos miles de gigas de recuerdos en <strong>Andorra y Canarias</strong>.
                </span>
            </div>

            <div class="log-item" onclick="openModal('2024.jpg')">
                <span class="version">v2024.01.01 - The Pro Version</span> 
                <span class="click-hint">üì∑ Ver recuerdo</span>
                <span class="date">2024</span>
                <span class="description">
                   El cortafuegos de "Tipo Duro" ha sido desactivado con √©xito. Acceso de administrador concedido para futuras usuarias (Nivel: Hijas). Vulnerabilidad ante ellas: 100%.
                </span>
            </div>

            <div class="log-item" onclick="openModal('2025.jpg')">
                <span class="version">v2025.10.21 - Solid Foundation</span> 
                <span class="click-hint">üì∑ Ver recuerdo</span>
                <span class="date">21/10/2025</span>
                <span class="description">
                    <strong>Reserva de infraestructura completada.</strong> Se han asignado los recursos f√≠sicos para el despliegue del servidor 'Nuestra Casa'. Ping de ilusi√≥n: Infinito.
                </span>
            </div>

            <div class="log-item" style="border-left: 3px solid #ff7b72;" onclick="openModal('2026.jpg')">
                <span class="version">v2026.02.14 - San Valent√≠n Update</span> 
                <span class="click-hint">üì∑ Ver recuerdo</span>
                <span class="date">HOY</span>
                <span class="description">
                    Seguimos sumando momentos, fotos y razones para quererte. Eres mi persona favorita.
                </span>
            </div>

            <div class="log-item future-item" onclick="openModal('2028.jpg')">
                <span class="version">v2028.x.x - Project: HOME</span> 
                <span class="click-hint">üì∑ Ver plano/render</span>
                <span class="date">FUTURO PR√ìXIMO</span>
                <span class="description">
                    <strong>Roadmap Objetivo:</strong> Finalizaci√≥n de la compilaci√≥n de la estructura. Entrega de claves de acceso f√≠sicas (llaves) y despliegue total en el entorno de producci√≥n 'Nuestra Casa'.<br>
                    Status: <em>Migrating to localhost:2028... [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100% Loaded.</em>
                </span>
            </div>

        </div>

        <a href="#" onclick="alert('Renovado hasta el 01/06/2100 ¬°Te quiero infinito! ‚ù§Ô∏è')" class="btn hidden">
            Renovar contrato de amor
        </a>

        <div class="footer">
            <p>Hecho con HTML, CSS y much√≠smo amor | 2026</p>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        
        <img class="modal-content" id="modalImg" style="display:none;">
        
        <div id="game-area" style="display:none;">
            <h2 style="color:#ff7b72; font-family:'Courier New'; margin-bottom:5px;">‚ö†Ô∏è STASH OVERLOAD</h2>
            <p style="color:#8b949e; font-size:0.8rem; margin-bottom:15px;">GRID: 6x8. ITEMS: 48 SLOTS. ZERO GAPS.</p>
            
            <div class="stash-container">
                <div class="stash-grid-bg" id="stash-grid"></div>
            </div>

            <div class="loose-pool" id="pool">
                </div>

            <div id="win-screen">
                <img src="loot.jpg" style="max-width:300px; border:2px solid #d2a8ff; border-radius:5px;">
                <br>
                <div class="found-in-raid-badge">‚úî FOUND IN RAID</div>
                <p style="color:#fff; margin-top:10px;">Extraction Successful!</p>
            </div>
        </div>
    </div>

    <script>
        // --- FECHA Y CONTADOR ---
        const startDate = new Date(2020, 5, 1); 
        function updateUptime() {
            const now = new Date();
            const diff = now - startDate;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            document.getElementById("uptime").innerText = 
                `${years} A√±os, ${remainingDays} D√≠as, ${hours}h ${minutes}m ${seconds}s`;
        }
        setInterval(updateUptime, 1000);
        updateUptime();

        // --- PART√çCULAS ---
        function createParticle() {
            const container = document.getElementById('particles-container');
            const particle = document.createElement('div');
            particle.classList.add('particle');
            const symbols = ['‚ù§Ô∏è', '‚ö°', 'üíñ', 'üíç', 'üè†'];
            particle.innerText = symbols[Math.floor(Math.random() * symbols.length)];
            particle.style.left = Math.random() * 100 + 'vw';
            const duration = Math.random() * 5 + 5; 
            particle.style.animationDuration = duration + 's';
            particle.style.fontSize = (Math.random() * 1.5 + 1) + 'rem'; 
            container.appendChild(particle);
            setTimeout(() => { particle.remove(); }, duration * 1000);
        }
        setInterval(createParticle, 400);

        // --- FADE IN ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('show');
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.hidden').forEach((el) => observer.observe(el));

        // --- M√öSICA ---
        const audio = document.getElementById("myAudio");
        const playBtn = document.querySelector(".play-btn");
        const eq = document.getElementById("eq");
        let isPlaying = false;
        function toggleMusic() {
            if (isPlaying) { audio.pause(); playBtn.innerText = "‚ñ∂"; eq.classList.remove("playing"); } 
            else { audio.play(); playBtn.innerText = "‚è∏"; eq.classList.add("playing"); }
            isPlaying = !isPlaying;
        }

        // --- MODALES ---
        const modal = document.getElementById("imageModal");
        const imgDisplay = document.getElementById("modalImg");
        const gameDisplay = document.getElementById("game-area");

        function openModal(imageSrc) {
            modal.style.display = "block";
            imgDisplay.style.display = "block";
            gameDisplay.style.display = "none";
            imgDisplay.src = imageSrc;
        }
        function closeModal() { modal.style.display = "none"; }

        // --- JUEGO: LOGIC HARDCORE 6x8 (48 Slots) ---
        const GRID_COLS = 6;
        const GRID_ROWS = 8;
        const CELL_PX = 45; // Tama√±o celda para que entre en m√≥viles
        let gridState = Array(GRID_ROWS).fill().map(() => Array(GRID_COLS).fill(0)); 
        
        // ITEMS QUE SUMAN EXACTAMENTE 48 CELDAS
        const itemsConfig = [
            { id: 1, type: 'backpack', w: 3, h: 3, icon: 'üéí' }, // 9
            { id: 2, type: 'vest', w: 2, h: 3, icon: 'ü¶∫' },     // 6
            { id: 3, type: 'rifle', w: 6, h: 1, icon: 'üî´' },    // 6 (Largo!)
            { id: 4, type: 'box', w: 4, h: 2, icon: 'üì¶' },      // 8
            { id: 5, type: 'case', w: 3, h: 2, icon: 'üß≥' },     // 6
            { id: 6, type: 'helmet', w: 2, h: 2, icon: '‚õëÔ∏è' },   // 4
            { id: 7, type: 'pistol', w: 2, h: 1, icon: 'üî´' },   // 2
            { id: 8, type: 'meds', w: 1, h: 1, icon: 'üíä' },     // 1
            { id: 9, type: 'wallet', w: 1, h: 1, icon: 'üí∂' },   // 1
            { id: 10, type: 'keys', w: 1, h: 1, icon: 'üîë' },    // 1
            { id: 11, type: 'ring', w: 1, h: 1, icon: 'üíç' },    // 1
            { id: 12, type: 'ammo', w: 1, h: 1, icon: 'üí£' },    // 1
            { id: 13, type: 'phone', w: 1, h: 1, icon: 'üì±' },   // 1
            { id: 14, type: 'map', w: 1, h: 1, icon: 'üó∫Ô∏è' }     // 1
        ]; // TOTAL: 9+6+6+8+6+4+2+1+1+1+1+1+1+1 = 48

        let placedItems = 0;

        function openGame() {
            modal.style.display = "block";
            imgDisplay.style.display = "none";
            gameDisplay.style.display = "flex";
            resetGame();
        }

        function resetGame() {
            const pool = document.getElementById('pool');
            pool.innerHTML = '';
            document.getElementById('stash-grid').innerHTML = ''; 
            document.getElementById('win-screen').style.display = 'none';
            document.querySelector('.stash-container').style.display = 'block';
            pool.style.display = 'flex';
            
            gridState = Array(GRID_ROWS).fill().map(() => Array(GRID_COLS).fill(0));
            placedItems = 0;

            itemsConfig.forEach(conf => {
                let el = document.createElement('div');
                el.className = 'item';
                el.innerText = conf.icon;
                el.setAttribute('data-w', conf.w);
                el.setAttribute('data-h', conf.h);
                el.setAttribute('data-id', conf.id);
                
                el.addEventListener('mousedown', startDrag);
                el.addEventListener('touchstart', startDrag, {passive: false});
                
                pool.appendChild(el);
            });
        }

        // DRAG LOGIC REFINADA
        function startDrag(e) {
            e.preventDefault();
            let item = this;
            
            if(item.classList.contains('placed')) {
                let oldCol = parseInt(item.dataset.col);
                let oldRow = parseInt(item.dataset.row);
                let w = parseInt(item.dataset.w);
                let h = parseInt(item.dataset.h);
                freeGrid(oldCol, oldRow, w, h);
                item.classList.remove('placed');
                placedItems--;
            }

            let startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            let startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            
            let rect = item.getBoundingClientRect();
            let shiftX = startX - rect.left;
            let shiftY = startY - rect.top;

            // Z-INDEX SUPREMO PARA QUE NO SE ESCONDA
            item.style.position = 'fixed';
            item.style.zIndex = 9999;
            item.style.left = rect.left + 'px';
            item.style.top = rect.top + 'px';
            item.style.transition = 'none'; // Quitar lag al arrastrar
            document.body.appendChild(item);

            function moveAt(pageX, pageY) {
                item.style.left = pageX - shiftX + 'px';
                item.style.top = pageY - shiftY + 'px';
            }

            function onMove(e) {
                let curX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                let curY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                moveAt(curX, curY);
            }

            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, {passive: false});

            function onEnd(e) {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
                
                item.style.transition = 'transform 0.1s'; // Restaurar animaci√≥n

                // Check Drop Target
                let stash = document.getElementById('stash-grid');
                let stashRect = stash.getBoundingClientRect();
                let itemRect = item.getBoundingClientRect();

                let relX = itemRect.left - stashRect.left;
                let relY = itemRect.top - stashRect.top;

                let col = Math.round(relX / CELL_PX);
                let row = Math.round(relY / CELL_PX);
                
                let w = parseInt(item.dataset.w);
                let h = parseInt(item.dataset.h);

                if (isValidPlacement(col, row, w, h)) {
                    snapToGrid(item, col, row, w, h);
                } else {
                    returnToPool(item);
                }
            }

            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchend', onEnd);
        }

        function isValidPlacement(col, row, w, h) {
            if (col < 0 || row < 0 || col + w > GRID_COLS || row + h > GRID_ROWS) return false;
            for(let r=row; r<row+h; r++) {
                for(let c=col; c<col+w; c++) {
                    if(gridState[r][c] !== 0) return false;
                }
            }
            return true;
        }

        function snapToGrid(item, col, row, w, h) {
            for(let r=row; r<row+h; r++) {
                for(let c=col; c<col+w; c++) {
                    gridState[r][c] = 1;
                }
            }
            let stash = document.getElementById('stash-grid');
            stash.appendChild(item);
            
            item.style.position = 'absolute';
            item.style.zIndex = 100;
            item.style.left = (col * CELL_PX) + 'px';
            item.style.top = (row * CELL_PX) + 'px';
            item.classList.add('placed');
            item.dataset.col = col;
            item.dataset.row = row;

            placedItems++;
            checkWin();
        }

        function freeGrid(col, row, w, h) {
            for(let r=row; r<row+h; r++) {
                for(let c=col; c<col+w; c++) {
                    gridState[r][c] = 0;
                }
            }
        }

        function returnToPool(item) {
            let pool = document.getElementById('pool');
            pool.appendChild(item);
            item.style.position = 'relative';
            item.style.left = 'auto';
            item.style.top = 'auto';
            item.style.zIndex = 10;
        }

        function checkWin() {
            if(placedItems === itemsConfig.length) {
                setTimeout(() => {
                    document.querySelector('.stash-container').style.display = 'none';
                    document.getElementById('pool').style.display = 'none';
                    document.getElementById('win-screen').style.display = 'block';
                }, 500);
            }
        }

    </script>
</body>
</html>